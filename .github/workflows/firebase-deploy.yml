name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: saoweb-7e02a

      - name: Notificar deploy exitoso
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "SAO 2026 - Deploy exitoso"
          body: |
            Deploy completado exitosamente.

            Commit: ${{ github.sha }}
            Mensaje: ${{ github.event.head_commit.message }}
            Autor: ${{ github.actor }}
            Fecha: ${{ github.event.head_commit.timestamp }}
          to: dspato@gmail.com
          from: SAO Deploy <${{ secrets.MAIL_USERNAME }}>

      - name: Notificar deploy fallido
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "SAO 2026 - Deploy FALLIDO"
          body: |
            El deploy fall√≥. Revisar los logs en GitHub Actions.

            Commit: ${{ github.sha }}
            Mensaje: ${{ github.event.head_commit.message }}
            Ver logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: dspato@gmail.com
          from: SAO Deploy <${{ secrets.MAIL_USERNAME }}>
